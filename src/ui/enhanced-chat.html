<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piggie Chat</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background: var(--vscode-editor-background);
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 8px 12px;
            background: var(--vscode-titleBar-activeBackground);
            border-bottom: 1px solid var(--vscode-input-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .mode-toggle {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid var(--vscode-input-border);
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .mode-toggle.active {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .controls-bar {
            padding: 8px 12px;
            background: var(--vscode-sideBar-background);
            border-bottom: 1px solid var(--vscode-input-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            gap: 8px;
        }
        .controls-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .controls-right {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .model-select {
            background: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            min-width: 100px;
        }
        .auto-toggle {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid var(--vscode-input-border);
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .auto-toggle.active {
            background: var(--vscode-charts-green);
            color: white;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            scroll-behavior: smooth;
        }
        .message {
            margin: 12px 0;
            padding: 12px;
            border-radius: 6px;
            background: var(--vscode-textBlockQuote-background);
            border-left: 3px solid var(--vscode-textBlockQuote-border);
            white-space: pre-wrap;
            line-height: 1.4;
            position: relative;
        }
        .message.user {
            background: var(--vscode-inputValidation-infoBackground);
            border-left-color: var(--vscode-inputValidation-infoBorder);
            margin-left: 20px;
        }
        .message.ai {
            background: var(--vscode-textBlockQuote-background);
            border-left-color: var(--vscode-charts-blue);
        }
        .message.error {
            background: var(--vscode-inputValidation-errorBackground);
            border-left-color: var(--vscode-inputValidation-errorBorder);
        }
        .input-area {
            padding: 12px;
            background: var(--vscode-sideBar-background);
            border-top: 1px solid var(--vscode-input-border);
            flex-shrink: 0;
        }
        .input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        #messageInput {
            width: 100%;
            min-height: 36px;
            max-height: 120px;
            padding: 8px 12px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            font-size: inherit;
            line-height: 1.4;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        button {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        button:hover {
            background: var(--vscode-button-hoverBackground);
        }
        button:disabled {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-primary {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .btn-secondary {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid var(--vscode-input-border);
        }
        .btn-danger {
            background: var(--vscode-inputValidation-errorBackground);
            color: var(--vscode-inputValidation-errorForeground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
        }
        .emoji-bar {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .emoji-btn {
            background: var(--vscode-button-secondaryBackground);
            border: 1px solid var(--vscode-input-border);
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .emoji-btn:hover {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .status {
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            background: var(--vscode-textBlockQuote-background);
            border-left: 3px solid var(--vscode-textBlockQuote-border);
            font-size: 12px;
        }
        .status.indexed {
            background: var(--vscode-inputValidation-infoBackground);
            border-left-color: var(--vscode-charts-green);
        }
        .typing-indicator {
            display: none;
            padding: 8px 12px;
            font-style: italic;
            color: var(--vscode-descriptionForeground);
            font-size: 12px;
        }
        .typing-indicator.show {
            display: block;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with mode toggles -->
        <div class="header">
            <div class="header-left">
                <span>üê∑ Piggie Chat</span>
            </div>
            <div class="header-right">
                <button class="mode-toggle active" id="manifestoMode" onclick="toggleManifestoMode()">
                    üõ°Ô∏è Manifesto
                </button>
                <button class="mode-toggle" id="freeMode" onclick="toggleFreeMode()">
                    üÜì Free
                </button>
            </div>
        </div>

        <!-- Controls bar -->
        <div class="controls-bar">
            <div class="controls-left">
                <button onclick="indexCodebase()" id="indexBtn">üìö Index Codebase</button>
                <div class="status" id="indexStatus">üìö Codebase not indexed</div>
            </div>
            <div class="controls-right">
                <select class="model-select" id="modelSelect" onchange="changeModel()">
                    <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
                <button class="auto-toggle" id="autoToggle" onclick="toggleAuto()">
                    ü§ñ Auto: OFF
                </button>
                <button class="btn-secondary" onclick="newChat()">üÜï New Chat</button>
            </div>
        </div>

        <!-- Messages area -->
        <div class="messages" id="messages">
            <div class="message ai">üê∑ Welcome to Piggie! I'm your manifesto-compliant coding assistant.</div>
        </div>

        <!-- Typing indicator -->
        <div class="typing-indicator" id="typingIndicator">
            üê∑ Piggie is thinking...
        </div>

        <!-- Input area -->
        <div class="input-area">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea id="messageInput" placeholder="Ask Piggie anything about your code..." onkeydown="handleKeyDown(event)"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="sendMessage()" id="sendBtn">üì§ Send</button>
                    <button class="btn-danger" onclick="stopGeneration()" id="stopBtn" style="display: none;">‚èπÔ∏è Stop</button>
                </div>
            </div>

            <!-- Emoji quick responses -->
            <div class="emoji-bar">
                <button class="emoji-btn" onclick="quickResponse('üëç Looks good!')">üëç Good</button>
                <button class="emoji-btn" onclick="quickResponse('‚ùì Can you explain more?')">‚ùì Explain</button>
                <button class="emoji-btn" onclick="quickResponse('üîß Please fix this')">üîß Fix</button>
                <button class="emoji-btn" onclick="quickResponse('üìù Add documentation')">üìù Docs</button>
                <button class="emoji-btn" onclick="quickResponse('üß™ Add tests')">üß™ Tests</button>
                <button class="emoji-btn" onclick="quickResponse('‚ôªÔ∏è Refactor this')">‚ôªÔ∏è Refactor</button>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let isGenerating = false;
        let manifestoMode = true;
        let autoMode = false;
        let currentModel = 'claude-3.5-sonnet';

        // Initialize state
        document.addEventListener('DOMContentLoaded', function() {
            updateModeDisplay();
            updateAutoDisplay();
        });

        function indexCodebase() {
            const btn = document.getElementById('indexBtn');
            btn.disabled = true;
            btn.textContent = 'üìö Indexing...';
            vscode.postMessage({ command: 'indexCodebase' });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (message && !isGenerating) {
                addMessage(message, 'user');
                vscode.postMessage({
                    command: 'sendMessage',
                    message: message,
                    manifestoMode: manifestoMode,
                    model: currentModel
                });
                input.value = '';
                setGenerating(true);
            }
        }

        function quickResponse(message) {
            if (!isGenerating) {
                addMessage(message, 'user');
                vscode.postMessage({
                    command: 'sendMessage',
                    message: message,
                    manifestoMode: manifestoMode,
                    model: currentModel
                });
                setGenerating(true);
            }
        }

        function stopGeneration() {
            vscode.postMessage({ command: 'stopGeneration' });
            setGenerating(false);
        }

        function newChat() {
            const messages = document.getElementById('messages');
            messages.innerHTML = '<div class="message ai">üê∑ New chat started! How can I help you?</div>';
            vscode.postMessage({ command: 'newChat' });
        }

        function toggleManifestoMode() {
            manifestoMode = true;
            updateModeDisplay();
            vscode.postMessage({ command: 'changeMode', mode: 'manifesto' });
        }

        function toggleFreeMode() {
            manifestoMode = false;
            updateModeDisplay();
            vscode.postMessage({ command: 'changeMode', mode: 'free' });
        }

        function toggleAuto() {
            autoMode = !autoMode;
            updateAutoDisplay();
            vscode.postMessage({ command: 'setAutoMode', enabled: autoMode });
        }

        function changeModel() {
            const select = document.getElementById('modelSelect');
            currentModel = select.value;
            vscode.postMessage({ command: 'changeModel', model: currentModel });
        }

        function updateModeDisplay() {
            const manifestoBtn = document.getElementById('manifestoMode');
            const freeBtn = document.getElementById('freeMode');

            if (manifestoMode) {
                manifestoBtn.classList.add('active');
                freeBtn.classList.remove('active');
            } else {
                manifestoBtn.classList.remove('active');
                freeBtn.classList.add('active');
            }
        }

        function updateAutoDisplay() {
            const autoBtn = document.getElementById('autoToggle');
            if (autoMode) {
                autoBtn.classList.add('active');
                autoBtn.textContent = 'ü§ñ Auto: ON';
            } else {
                autoBtn.classList.remove('active');
                autoBtn.textContent = 'ü§ñ Auto: OFF';
            }
        }

        function setGenerating(generating) {
            isGenerating = generating;
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            const typingIndicator = document.getElementById('typingIndicator');

            if (generating) {
                sendBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                typingIndicator.classList.add('show');
            } else {
                sendBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                typingIndicator.classList.remove('show');
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function addMessage(content, type = 'ai') {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = content;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'addMessage':
                    addMessage(message.content, 'ai');
                    setGenerating(false);
                    break;
                case 'updateIndexStatus':
                    const status = document.getElementById('indexStatus');
                    const btn = document.getElementById('indexBtn');
                    if (message.isIndexed) {
                        status.textContent = `‚úÖ Indexed (${message.fileCount} files)`;
                        status.classList.add('indexed');
                        btn.textContent = 'üîÑ Re-index';
                        btn.disabled = false;
                    } else {
                        status.textContent = 'üìö Codebase not indexed';
                        status.classList.remove('indexed');
                        btn.textContent = 'üìö Index Codebase';
                        btn.disabled = false;
                    }
                    break;
                case 'error':
                    addMessage(`‚ùå Error: ${message.content}`, 'error');
                    setGenerating(false);
                    break;
            }
        });
    </script>
</body>
</html>
